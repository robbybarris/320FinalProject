---
title: "Predicting Baseball Games Against Gambling Lines"
author: "Robert Barris, Shivam Patel"
date: "5/18/2019"
output: pdf_document
---


This notebook will model a few baseball statistics to determine if we can predict future performance, win or loss, of a team at a time.
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
Important: 
    The information used here was obtained free of
     charge from and is copyrighted by Retrosheet.  Interested
     parties may contact Retrosheet at "www.retrosheet.org".

Sources: 

https://www.retrosheet.org/gamelogs/index.html

Libraries
```{r Libraries}
library(tidyverse)
library(lubridate)
library(dplyr)
library(caret)
library(zoo)
library(rvest)
library(ggplot2)
library(broom)
library(gridExtra)
library(plotly)
```





```{r Data Curation}
csv_file <- "~/Desktop/CMSC320/FinalProject/BBData.csv"
bdata <- read_csv(csv_file)
colnames(bdata)[3] <- c("VisitingTeam")
colnames(bdata)[6] <- c("HomeTeam")
colnames(bdata)[5] <- c("VTGameNumber")
colnames(bdata)[8] <- c("HTGameNumber")
colnames(bdata)[9] <- c("VTScore")
colnames(bdata)[10] <- c("HTScore")
colnames(bdata)[12] <- c("ParkID")
colnames(bdata)[13] <- c("VTPitchersUsed")
colnames(bdata)[14] <- c("VTIndivEarnedRuns")
colnames(bdata)[15] <- c("VTTeamEarnedRuns")
colnames(bdata)[16] <- c("HTPitchersUsed")
colnames(bdata)[17] <- c("HTIndivEarnedRuns")
colnames(bdata)[18] <- c("HTTeamEarnedRuns")
colnames(bdata)[19] <- c("VTStartingPitcherID")
colnames(bdata)[20] <- c("VTStartingPitcherName")
colnames(bdata)[21] <- c("HTStartingPitcherID")
colnames(bdata)[22] <- c("HTStartingPitcherName")
colnames(bdata)[23] <- c("FullData")
bdata <- mutate(bdata, WinningTeam = ifelse( bdata$VTScore<  bdata$HTScore, bdata$HomeTeam, bdata$VisitingTeam))
bdata <- mutate(bdata, HomeWin = ifelse(bdata$WinningTeam == bdata$HomeTeam, 1, 0))
bdata <- mutate(bdata, VTWin = ifelse(bdata$WinningTeam == bdata$HomeTeam, 1, 0)) 
away <- data.frame(Date = bdata$Date, Team = bdata$VisitingTeam, Game = bdata$VTGameNumber, Runs = bdata$VTScore, RunsAllowed = bdata$HTScore, Win = bdata$VTWin, stringsAsFactors=FALSE)
home <- data.frame(Date = bdata$Date, Team = bdata$HomeTeam, Game = bdata$HTGameNumber, Runs = bdata$HTScore, RunsAllowed = bdata$VTScore, Win = bdata$HomeWin, stringsAsFactors=FALSE)

goodData <- rbind(away,home)



odds <- "~/Desktop/CMSC320/FinalProject/2018odds.csv"
oddsdf <- read_csv(odds)
oddsdf$Date <- gsub("(^\\d{1})(\\d{2})","\\1/\\2/18", oddsdf$Date)


wanted_data <- data.frame(Date = oddsdf$Date, Team = oddsdf$Team, Pitcher = oddsdf$Pitcher, MoneyLine = oddsdf$Open, OU = oddsdf$`Open OU`, Spread = oddsdf$RL)

final <- merge(wanted_data, goodData, by=c("Date", "Team"))
final <- final %>%
  group_by(Team) %>%
mutate(lastTenMRA = rollsumr(RunsAllowed, k = 10, fill = NA)/10) %>%
  mutate(lastTenMR = rollsumr(Runs, k = 10, fill = NA)/10) %>%
  arrange(Game)

final
```



https://www.sportsbookreviewsonline.com/scoresoddsarchives/mlb/mlboddsarchives.htm





No that we have enough data we want to find the most predictive variables on wether a team will win or lose a game not yet played.
The first step is to visualize and run regressions on the variables.

RAG - Runs Allowed Per Game
Quality Starts - Starting pitcher allowed 3 or fewer than earned runs and pitched 6 or more innings





```{r, Data Visualization And Regressions}

p2<- final %>%
  group_by(Team)%>%
  ggplot(aes(x=lag(RunsAllowed), y = MoneyLine, color = Win)) +
    geom_point() + 
    geom_smooth(method=lm) + 
  labs(title="Previous Game Runs Allowed Effect on Vegas Money Line",
         x = "Previous Game Runs Allowed",
         y = "Money Line")

p1 <- final %>%
  group_by(Team)%>%
  ggplot(aes(x=lag(Runs), y = MoneyLine, color = Win)) +

    geom_point() + 
    geom_smooth(method=lm) + 
  labs(title="Previous Game Runs Effect on Vegas Money Line",
         x = "Previous Game Runs",
         y = "Money Line")

grid.arrange(p1,p2, ncol = 2)


final %>%
  group_by(Team)%>%
  ggplot(aes(x=lag(Runs), y = Win, color = MoneyLine)) +
    geom_point() + 
    geom_smooth(method=lm)


plot2 <- final %>%
filter(Team == "ARI" || Team == "BAL")%>%
  ggplot(aes(x=MoneyLine, y = Win, color = Team)) +
    geom_point() + 
    geom_smooth(method=lm)


plot1 <-final %>%
  filter(Team == "ARI" || Team == "BAL")%>%
  ggplot(aes(x=lastTenMRA, y = Win, color = Team)) +
    geom_point() + 
    geom_smooth(method=lm)


plot3 <-final %>%
  filter(Team == "ARI" || Team == "BAL")%>%
  ggplot(aes(x=lastTenMR, y = Win, color = Team)) +
    geom_point() + 
    geom_smooth(method=lm)


final %>%
  filter(Team == "ARI" || Team == "BAL")%>%
  ggplot(aes(x=lag(RunsAllowed), y = MoneyLine, color = Team)) +
    geom_point() + 
    geom_smooth(method=lm)
grid.arrange(plot1, plot2, plot3, ncol=3)
```






```{R, Regressions}
final <- final %>%
  group_by(Team)

  mulr <- lm(formula = final$Win ~ lag(Runs)*lag(RunsAllowed), data = final)
  mulrtidy <- mulr %>% tidy()
mulrtidy


  mulr1 <- lm(formula = final$Win ~ (lastTenMR)*(lastTenMRA), data = final)
  mulrtidy1 <- mulr1 %>% tidy()
mulrtidy1


multr <- lm(formula = MoneyLine ~ (lastTenMR)*(lastTenMRA), data = final)
multrst <- multr %>% tidy()
multrst




multreg <- lm(formula = MoneyLine ~ lag(Runs)*lag(RunsAllowed), data = final)
multregst <- multreg %>% tidy()
multregst

```